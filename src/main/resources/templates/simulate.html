<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_web.html">
<th:block layout:fragment="_content">
    <script th:src="@{/static/fintics-etf.js?version={version}(version=${_scriptVersion})}"></script>
    <script th:inline="javascript">
        // defines
        const assetSearch = new duice.ObjectProxy({
            market: null,
            dividendFrequencyMin: null,
            key: 'name',
            value: null,
            _page: 0,
            _size: 10,
            _sort: {
                property: null,
                direction: null
            },
            _count: -1,
            _status: null
        });
        const assets = new duice.ArrayProxy([]);
        const simulate = new duice.ObjectProxy({
            simulateAssets: [],
            investAmount: 1000,
            dateFrom: dateFns.format(dateFns.subYears(new Date(),1), 'YYYY-MM-DD'),
            dateTo: dateFns.format(dateFns.subDays(new Date(),1), 'YYYY-MM-DD')
        });

        // chart
        let simulateAssetChart = null;
        let simulateBalanceChart = null;

        /**
         * gets assets
         * @param page page number
         */
        function getAssets(page) {
            assetSearch._page = page | 0;
            let url = new URL(`${_apiUrl}/v1/assets`, document.location.origin);
            if (assetSearch.market != null) {
                url.searchParams.append('market', assetSearch.market);
            }
            if (assetSearch.dividendFrequencyMin != null) {
                url.searchParams.append('dividendFrequencyMin', assetSearch.dividendFrequencyMin);
            }
            if (assetSearch.key && assetSearch.value) {
                url.searchParams.append(assetSearch.key, assetSearch.value);
            }
            url.searchParams.append('_page', assetSearch._page);
            url.searchParams.append('_size', assetSearch._size);
            if (assetSearch._sort.property && assetSearch._sort.direction) {
                url.searchParams.append('_sort', `${assetSearch._sort.property},${assetSearch._sort.direction}`);
            }
            assetSearch._status = 'loading';
            duice.ArrayProxy.clear(assets);
            _fetch(url)
                .then(response => {
                    assetSearch._count = _parseTotalCount(response);
                    return response.json()
                })
                .then(data => {
                    // checks already selected
                    data.forEach(asset => {
                        const exist = simulate.simulateAssets.some(it => it.assetId === asset.assetId);
                        if (exist) {
                            asset._selected = true;
                        }
                    });
                    // assigns
                    duice.ArrayProxy.assign(assets, data);
                })
                .finally(() => {
                    assetSearch._status = 'completed';
                });
        }

        function getAssetsWithSort(element, property) {
            if (property === assetSearch._sort.property) {
                let direction = assetSearch._sort.direction;
                if (!direction) {
                    assetSearch._sort.direction = 'desc';
                } else if (direction === 'desc') {
                    assetSearch._sort.direction = 'asc';
                } else if (direction === 'asc') {
                    assetSearch._sort.direction = null;
                }
            } else {
                assetSearch._sort.property = property;
                assetSearch._sort.direction = 'desc';
            }
            getAssets(0);
        }

        function toggleAssetSort(element, property) {
            let imgSrc = '/static/image/icon-sort.svg';
            if (property === assetSearch._sort.property) {
                if (assetSearch._sort.direction) {
                    imgSrc = `/static/image/icon-sort-${assetSearch._sort.direction}.svg`;
                }
            }
            element.src = imgSrc;
        }

        /**
         * resets assets
         */
        function resetAssets() {
            duice.ObjectProxy.reset(assetSearch);
            getAssets();
        }

        function addBasketAsset(index) {
            let simulateAsset = JSON.parse(JSON.stringify(assets[index]));
            simulate.simulateAssets.push(simulateAsset);
            assets[index]._selected = true;
        }

        function removeBasketAsset(index) {
            const assetId = simulate.simulateAssets[index].assetId;
            simulate.simulateAssets.splice(index, 1);
            assets.forEach(it => {
                if (it.assetId === assetId) {
                    it._selected = false;
                }
            });
        }

        function openDividendDialog(assetId) {
            dividendDialog.open(assetId);
        }

        function openOhlcvDialog(assetId) {
            ohlcvDialog.open(assetId);
        }

        async function launchSimulate() {
            await _alert('TODO !!!!!!!!!!!!!!!!');
            let simulateLog = document.getElementById('simulate-log');
            let url = new URL(`${_apiUrl}/v1/simulates`, document.location.origin);
            _fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(simulate),
                signal: this.signal
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // read from stream
                function processText({ done, value }) {
                    if (done) {
                        simulateLog.value += `Script execution completed.\n`;
                        return;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    simulateLog.value += `${chunk}\n`;

                    // reads stream
                    return reader.read().then(processText);
                }

                // final read stream
                reader.read().then(processText);
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    simulateLog.value += `Fetch request was aborted.\n`;
                } else {
                    simulateLog.value += `An error occurred:${error}\n`;
                }
            });

            // test chart
            simulateAssetChart = _createLineChart('simulateAssetChart');
            const dataset = {
                label: 'test',
                data: [1,2,3],
                borderWidth: 1,
                pointStyle: false
            };

            simulateBalanceChart = _createLineChart('simulateBalanceChart');
        }

        // DOM content loaded listener
        document.addEventListener('DOMContentLoaded',()=> {
            getAssets();
        });
    </script>

    <!-- ====================================== -->
    <!-- start: title                           -->
    <!-- ====================================== -->
    <h1 id="title">
        <img class="icon" th:src="@{/static/image/icon-simulate.svg}" alt="asset"/>
        <span data-th-text="|#{fintics.etf.Simulate}|"></span>
    </h1>
    <!-- ====================================== -->
    <!-- end: title                             -->
    <!-- ====================================== -->
    <!-- ================================== -->
    <!-- start: assets                      -->
    <!-- ================================== -->
    <div class="panel">
        <div class="panel-title">
            <h2>
                <img class="icon" th:src="@{/static/image/icon-asset.svg}" alt="asset"/>
                <span data-th-text="|ETF #{web.global.search}|"></span>
            </h2>
        </div>
        <div class="panel-content">
            <form onsubmit="return false;" class="display--flex justify-content--space-between">
                <div class="display--flex flex-wrap--wrap gap--1px">
                    <div>
                        <label>
                            <select data-duice-bind="assetSearch" data-duice-property="market" class="width--100">
                                <option value="" data-th-text="|#{fintics.etf.Asset.market}...|"></option>
                                <option value="KR" data-th-text="#{fintics.etf.Asset.market.KR}"></option>
                                <option value="US" data-th-text="#{fintics.etf.Asset.market.US}"></option>
                            </select>
                        </label>
                    </div>
                    <div>
                        <label>
                            <select class="width--100" data-duice-bind="assetSearch" data-duice-property="dividendFrequencyMin">
                                <option value="" data-th-text="|#{fintics.etf.Asset.dividendFrequency}...|"></option>
                                <option value="1">1+ times</option>
                                <option value="4">4+ times</option>
                                <option value="12">12+ times</option>
                            </select>
                        </label>
                    </div>
                    <div class="display--flex flex-wrap--nowrap gap--1px">
                        <label>
                            <select data-duice-bind="assetSearch" data-duice-property="key">
                                <option value="name" th:text="#{fintics.etf.Asset.name}"></option>
                                <option value="assetId" th:text="#{fintics.etf.Asset.assetId}"></option>
                            </select>
                        </label>
                        <label>
                            <input type="text" data-duice-bind="assetSearch" data-duice-property="value"/>
                        </label>
                    </div>
                </div>
                <div class="flex--1 display--flex justify-content--end gap--1px">
                    <button type="submit" onclick="getAssets(0);">
                        <img class="icon" th:src="@{/static/image/icon-search.svg}" alt="search"/>
                        <span data-th-text="#{web.global.search}"></span>
                    </button>
                    <button type="button" onclick="resetAssets();">
                        <img class="icon" th:src="@{/static/image/icon-reset.svg}" alt="reset"/>
                        <span data-th-text="#{web.global.reset}"></span>
                    </button>
                </div>
            </form>
            <div class="overflow-x--scroll">
                <table class="width--100">
                    <colgroup>
                        <col style="width:3em;"/>
                        <col style="width:7em;"/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col/>
                        <col style="width:10em;"/>
                    </colgroup>
                    <thead>
                    <tr style="height:4em;">
                        <th></th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.symbol}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.name}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.market}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.updatedDate}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.marketCap}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.close}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.volume}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.dividendFrequency}"></span>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.dividendYield}"></span>
                            <img class="icon link"
                                 th:src="@{/static/image/icon-sort.svg}" alt=""
                                 data-duice-bind="assetSearch"
                                 data-duice-execute="toggleAssetSort(this, 'dividendYield');"
                                 onclick="getAssetsWithSort(this, 'dividendYield');"/>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.capitalGain}"></span>
                            <img class="icon link"
                                 th:src="@{/static/image/icon-sort.svg}" alt=""
                                 data-duice-bind="assetSearch"
                                 data-duice-execute="toggleAssetSort(this, 'capitalGain');"
                                 onclick="getAssetsWithSort(this, 'capitalGain');"/>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.totalReturn}"></span>
                            <img class="icon link"
                                 th:src="@{/static/image/icon-sort.svg}" alt=""
                                 data-duice-bind="assetSearch"
                                 data-duice-execute="toggleAssetSort(this, 'totalReturn');"
                                 onclick="getAssetsWithSort(this, 'totalReturn');"/>
                        </th>
                        <th>
                            <span data-th-text="#{fintics.etf.Asset.links}"></span>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr data-duice-bind="assets" data-duice-loop="asset,status" style="height:4em;">
                        <td class="text-align--center">
                            <button type="button" class="small"
                                    data-duice-bind="asset"
                                    data-duice-execute="
                                    this.dataset.index=status.index;
                                    if (asset._selected) {
                                        this.disabled = true;
                                    }
                                    "
                                    onclick="addBasketAsset(this.dataset.index);">
                                <img class="icon" th:src="@{/static/image/icon-add.svg}" alt="add"/>
                            </button>
                        </td>
                        <td class="text-align--center">
                            <span data-duice-bind="asset" data-duice-property="symbol" class="code font-weight--bold"></span>
                        </td>
                        <td>
                            <img class="icon border-radius--50 font-size--large" data-duice-bind="asset" data-duice-property="icon" th:onerror="|this.onerror=null; this.src='@{/static/image/icon-asset.svg}';|" alt=""/>
                            &nbsp;
                            <span data-duice-bind="asset" data-duice-property="name"></span>
                        </td>
                        <td class="text-align--center">
                            <span data-duice-bind="asset" data-duice-property="market" class="badge code"></span>
                        </td>
                        <td class="text-align--center">
                            <span data-duice-bind="asset" data-duice-property="updatedDate" class="date"></span>
                        </td>
                        <td class="text-align--right">
                            <span data-duice-bind="asset" data-duice-property="marketCap" data-duice-format="number()" class="number"></span>
                        </td>
                        <td class="text-align--right">
                            <span data-duice-bind="asset" data-duice-property="close" data-duice-format="number()" class="number"></span>
                            <small class="link"
                                   data-duice-bind="asset"
                                   data-duice-execute="this.dataset.assetId = asset.assetId;"
                                   onclick="openOhlcvDialog(this.dataset.assetId);">
                                <img class="icon" th:src="@{/static/image/icon-open.svg}" alt=""/>
                            </small>
                        </td>
                        <td class="text-align--right">
                            <span data-duice-bind="asset" data-duice-property="volume" data-duice-format="number()" class="number"></span>
                        </td>
                        <td class="text-align--center">
                            <span data-duice-bind="asset" data-duice-property="dividendFrequency" class="number"></span>
                            <small class="link"
                                   data-duice-bind="asset"
                                   data-duice-execute="this.dataset.assetId = asset.assetId;"
                                   onclick="openDividendDialog(this.dataset.assetId);">
                                <img class="icon" th:src="@{/static/image/icon-open.svg}" alt=""/>
                            </small>
                        </td>
                        <td class="text-align--right">
                            <span data-duice-bind="asset" data-duice-property="dividendYield" data-duice-format="number()" class="number"></span>
                            <small class="code">%</small>
                        </td>
                        <td class="text-align--right">
                            <span data-duice-bind="asset" data-duice-property="capitalGain" data-duice-format="number()" class="number"></span>
                            <small class="code">%</small>
                        </td>
                        <td class="text-align--right font-weight--bold">
                            <span data-duice-bind="asset"
                                  data-duice-property="totalReturn"
                                  data-duice-format="number()"
                                  data-duice-execute="
                                  if (asset.totalReturn > 0) this.classList.add('color--green');
                                  if (asset.totalReturn < 0) this.classList.add('color--red');
                                  "
                                  class="number"></span>
                            <small class="code">%</small>
                        </td>

                        <td class="text-align--center">
                            <select data-duice-bind="asset"
                                    data-duice-option="asset.links"
                                    data-duice-option-value-property="url"
                                    data-duice-option-text-property="name"
                                    onchange="_openLink(this.value, '_blank'); this.value = '';"
                                    class="code font-size--smaller">
                                <option value>Link...</option>
                            </select>
                        </td>
                    </tr>
                    <tr data-duice-bind="assetSearch"
                        data-duice-if="return assetSearch._status === 'loading';"
                        style="height:4em;">
                        <td colspan="100%" class="text-align--center">
                            <img class="icon font-size--larger" th:src="@{/static/image/loading.svg}" alt="loading"/>
                        </td>
                    </tr>
                    <tr data-duice-bind="assetSearch"
                        data-duice-if="return assetSearch._status === 'completed' && assets.length < 1;"
                        style="height:4em;" hidden>
                        <td colspan="100%" class="text-align--center">
                            <span data-th-text="#{web.global.itemNotFound(#{fintics.etf.Asset})}"></span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="display--flex justify-content--space-between">
                <div class="flex--1">
                    <span data-th-text="#{web.global.total}"></span>
                    <span data-duice-bind="assetSearch" data-duice-property="_count" data-duice-format="number(0)" class="number"></span>
                    <span data-th-text="#{web.global.rows}"></span>
                </div>
                <div class="flex--1 display--flex justify-content--center">
                    <duice-pagination
                            data-duice-bind="assetSearch"
                            data-duice-size-property="_size"
                            data-duice-page-property="_page"
                            data-duice-count-property="_count"
                            data-duice-onclick="getAssets(this.dataset.page);"
                            class="number">
                    </duice-pagination>
                </div>
                <div class="flex--1"></div>
            </div>
        </div>
    </div>
    <!-- ================================== -->
    <!-- end: assets                        -->
    <!-- ================================== -->
    <br/>
    <!-- ================================== -->
    <!-- start: simulate                    -->
    <!-- ================================== -->
    <div class="panel">
        <div class="panel-title">
            <h2>
                <img class="icon" th:src="@{/static/image/icon-simulate.svg}" alt="simulate"/>
                <span data-th-text="|#{fintics.etf.Simulate}|"></span>
            </h2>
        </div>
        <div class="panel-content">
            <form onsubmit="return false;" class="display--grid grid-template-columns--12fr gap--1em">
                <div class="grid-column--span-12">
                    <div>
                        <span data-th-text="#{fintics.etf.BasketAsset}" class="font-weight--bold tag-required"></span>
                    </div>
                    <div class="overflow-x--auto box">
                        <table class="width--100 border--none">
                            <colgroup>
                                <col style="width:3em;"/>
                                <col style="width:7em;"/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col/>
                                <col style="width:10em;"/>
                                <col style="width:5em;"/>
                            </colgroup>
                            <thead>
                            <tr style="height:4em;">
                                <th></th>
                                <th data-th-text="#{fintics.etf.Asset.symbol}"></th>
                                <th data-th-text="#{fintics.etf.Asset.name}"></th>
                                <th data-th-text="#{fintics.etf.Asset.market}"></th>
                                <th data-th-text="#{fintics.etf.Asset.updatedDate}"></th>
                                <th data-th-text="#{fintics.etf.Asset.marketCap}"></th>
                                <th data-th-text="#{fintics.etf.Asset.close}"></th>
                                <th data-th-text="#{fintics.etf.Asset.volume}"></th>
                                <th data-th-text="#{fintics.etf.Asset.dividendFrequency}"></th>
                                <th data-th-text="#{fintics.etf.Asset.dividendYield}"></th>
                                <th data-th-text="#{fintics.etf.Asset.capitalGain}"></th>
                                <th data-th-text="#{fintics.etf.Asset.totalReturn}"></th>
                                <th data-th-text="#{fintics.etf.Asset.links}"></th>
                                <th data-th-text="#{fintics.etf.BasketAsset.holdingWeight}"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr data-duice-bind="simulate.simulateAssets" data-duice-loop="simulateAsset,status" style="height:4em;">
                                <td class="text-align--center">
                                    <button type="button" class="small"
                                            data-duice-bind="simulateAsset"
                                            data-duice-execute="this.dataset.index=status.index;"
                                            onclick="removeBasketAsset(this.dataset.index);">
                                        <img class="icon" th:src="@{/static/image/icon-remove.svg}" alt="remove"/>
                                    </button>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="simulateAsset" data-duice-property="symbol" class="code font-weight--bold"></span>
                                </td>
                                <td>
                                    <img class="icon border-radius--50 font-size--large" data-duice-bind="simulateAsset" data-duice-property="icon" th:onerror="|this.onerror=null; this.src='@{/static/image/icon-simulateAsset.svg}';|" alt=""/>
                                    &nbsp;
                                    <span data-duice-bind="simulateAsset" data-duice-property="name"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="simulateAsset" data-duice-property="market" class="badge"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="simulateAsset" data-duice-property="updatedDate" class="date"></span>
                                </td>
                                <td class="text-align--right">
                                    <span data-duice-bind="simulateAsset" data-duice-property="marketCap" data-duice-format="number()" class="number"></span>
                                </td>
                                <td class="text-align--right">
                                    <span data-duice-bind="simulateAsset" data-duice-property="close" data-duice-format="number()" class="number"></span>
                                    <small class="link"
                                           data-duice-bind="simulateAsset"
                                           data-duice-execute="this.dataset.assetId = simulateAsset.assetId;"
                                           onclick="openOhlcvDialog(this.dataset.assetId);">
                                        <img class="icon" th:src="@{/static/image/icon-open.svg}" alt=""/>
                                    </small>
                                </td>
                                <td class="text-align--right">
                                    <span data-duice-bind="simulateAsset" data-duice-property="volume" data-duice-format="number()" class="number"></span>
                                </td>
                                <td class="text-align--center">
                                    <span data-duice-bind="simulateAsset" data-duice-property="dividendFrequency" data-duice-format="number()" class="number"></span>
                                    <small class="link"
                                           data-duice-bind="simulateAsset"
                                           data-duice-execute="this.dataset.assetId = simulateAsset.assetId;"
                                           onclick="openDividendDialog(this.dataset.assetId);">
                                        <img class="icon" th:src="@{/static/image/icon-open.svg}" alt=""/>
                                    </small>
                                </td>
                                <td class="text-align--right">
                                    <span data-duice-bind="simulateAsset" data-duice-property="dividendYield" data-duice-format="number()" class="number"></span>
                                    <small class="code">%</small>
                                </td>
                                <td class="text-align--right">
                                    <span data-duice-bind="simulateAsset" data-duice-property="capitalGain" data-duice-format="number()" class="number"></span>
                                    <small class="code">%</small>
                                </td>
                                <td class="text-align--right font-weight--bold">
                            <span data-duice-bind="simulateAsset"
                                  data-duice-property="totalReturn"
                                  data-duice-format="number()"
                                  data-duice-execute="
                                  if (simulateAsset.totalReturn > 0) this.classList.add('color--green');
                                  if (simulateAsset.totalReturn < 0) this.classList.add('color--red');
                                  "
                                  class="number"></span>
                                    <small class="code">%</small>
                                </td>
                                <td class="text-align--center">
                                    <select data-duice-bind="simulateAsset"
                                            data-duice-option="simulateAsset.links"
                                            data-duice-option-value-property="url"
                                            data-duice-option-text-property="name"
                                            onchange="_openLink(this.value, '_blank'); this.value = '';"
                                            class="code font-size--smaller">
                                        <option value>Link...</option>
                                    </select>
                                </td>
                                <td class="text-align--right">
                                    <label>
                                        <input type="number"
                                               data-duice-bind="simulateAsset"
                                               data-duice-property="holdingWeight"
                                               class="number font-weight--bold"
                                               style="width:5em;"/>
                                        <small class="code">%</small>
                                    </label>
                                </td>
                            </tr>
                            <tr data-duice-bind="simulate"
                                data-duice-if="return simulate.simulateAssets.length < 1;"
                                style="height:4em;"
                                hidden>
                                <td colspan="100%" class="text-align--center">
                                    <span data-th-text="#{web.global.itemNotFound(#{fintics.etf.Asset})}"></span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="grid-column--span-4 s__grid-column--span-12">
                    <label>
                        <span data-th-text="#{fintics.etf.Simulate.investAmount}" class="font-weight--bold tag-required"></span>
                        <input type="text"
                               data-duice-bind="simulate"
                               data-duice-property="investAmount"
                               data-duice-format="number(0)"
                               class="width--100 text-align--right font-weight--bold"/>
                    </label>
                </div>
                <div class="grid-column--span-4 s__grid-column--span-12">
                    <label class="grid-column--4 s__grid-column--12">
                        <span data-th-text="#{fintics.etf.Simulate.dateFrom}" class="font-weight--bold tag-required"></span>
                        <input type="date" class="width--100 date"
                               data-duice-bind="simulate"
                               data-duice-property="dateFrom"/>
                    </label>
                </div>
                <div class="grid-column--span-4 s__grid-column--span-12">
                    <label class="grid-column--4 s__grid-column--12">
                        <span data-th-text="#{fintics.etf.Simulate.dateTo}" class="font-weight--bold tag-required"></span>
                        <input type="date" class="width--100 date"
                               data-duice-bind="simulate"
                               data-duice-property="dateTo"/>
                    </label>
                </div>
            </form>
            <div class="text-align--center padding--1em">
                <button type="button" onclick="launchSimulate();">
                    <img class="icon" th:src="@{/static/image/icon-confirm.svg}" alt="save"/>
                    <span data-th-text="#{web.global.confirm}"></span>
                </button>
            </div>
            <div>
                <div>
                    <label>
                    <span>
                        <img class="icon" th:src="@{/static/image/icon-log.svg}" alt="log">
                        <span data-th-text="|#{web.global.log}|" class="font-weight--bold"></span>
                    </span>
                        <textarea id="simulate-log" class="width--100 code" rows="5"></textarea>
                    </label>
                </div>
                <div class="width-100" style="height:200px;">
                    <canvas id="simulateAssetChart"></canvas >
                </div>
                <div class="width-100" style="height:200px;">
                    <canvas id="simulateBalanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- ================================== -->
    <!-- start: simulate                    -->
    <!-- ================================== -->

    <!-- ================================== -->
    <!-- start: dividend dialog             -->
    <!-- ================================== -->
    <dialog id="dividendDialog">
        <style th:inline="css">
            #dividendDialog {
                width: 400px;
                min-height: 400px;
            }
        </style>
        <script th:inline="javascript">
            const dividendDialog = {
                dialog: new duice.Dialog(document.getElementById('dividendDialog')),
                dividendSearch: new duice.ObjectProxy({
                    assetId: null,
                    _status: null
                }),
                dividends: new duice.ArrayProxy([]),
                open: function(assetId) {
                    duice.ObjectProxy.reset(this.dividendSearch);
                    duice.ArrayProxy.clear(this.dividends);
                    this.dividendSearch.assetId = assetId;
                    const promise = this.dialog.open();
                    this.getDividends();
                    return promise;
                },
                getDividends: async function() {
                    let url = new URL(`${_apiUrl}/v1/dividends/${this.dividendSearch.assetId}`, document.location.origin);
                    this.dividendSearch._status = 'loading';
                    await _fetch(url)
                        .then(response => {
                            return response.json();
                        })
                        .then(data => {
                            duice.ArrayProxy.assign(this.dividends, data);
                            this.dividendSearch._status = 'completed';
                        });
                }
            }
        </script>
        <div class="display--flex flex-direction--column padding--1em">
            <div>
                <h2>
                    <img class="icon" th:src="@{/static/image/icon-dividend.svg}" alt=""/>
                    <span data-th-text="#{fintics.etf.Dividend}"></span>
                </h2>
            </div>
            <div class="display--flex flex-direction--column gap--1em padding--1em">
                <div class="overflow-y--scroll box" style="max-height:400px;">
                    <table class="width--100 border--none">
                        <colgroup>
                            <col/>
                            <col/>
                        </colgroup>
                        <thead>
                        <tr>
                            <th data-th-text="#{fintics.etf.Dividend.date}"></th>
                            <th data-th-text="#{fintics.etf.Dividend.amount}" class="text-align--center"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-duice-bind="dividendDialog.dividends" data-duice-loop="dividend,status">
                            <td>
                                <span data-duice-bind="dividend" data-duice-property="date" class="date"></span>
                            </td>
                            <td class="text-align--center">
                                <span data-duice-bind="dividend" data-duice-property="amount" data-duice-format="number()" class="number"></span>
                            </td>
                        </tr>
                        <tr data-duice-bind="dividendDialog.dividendSearch"
                            data-duice-if="return dividendDialog.dividendSearch._status === 'loading';" hidden>
                            <td colspan="100%" class="text-align--center">
                                <img class="icon font-size--larger" th:src="@{/static/image/loading.svg}" alt="loading"/>
                            </td>
                        </tr>
                        <tr data-duice-bind="dividendDialog.dividendSearch"
                            data-duice-if="return dividendDialog.dividendSearch._status === 'completed' && dividendDialog.dividends.length < 1;" hidden>
                            <td colspan="100%" class="text-align--center font-size--smaller">
                                <span data-th-text="#{web.global.itemNotFound(#{fintics.etf.Dividend})}"></span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </dialog>
    <!-- ================================== -->
    <!-- end: dividend dialog               -->
    <!-- ================================== -->

    <!-- ================================== -->
    <!-- start: ohlcv dialog                -->
    <!-- ================================== -->
    <dialog id="ohlcvDialog">
        <style th:inline="css">
            #ohlcvDialog {
                width: 800px;
            }
        </style>
        <script th:inline="javascript">
            const ohlcvDialog = {
                dialog: new duice.Dialog(document.getElementById('ohlcvDialog')),
                ohlcvSearch: new duice.ObjectProxy({
                    assetId: null,
                    _status: null
                }),
                ohlcvs: new duice.ArrayProxy([]),
                open: async function(assetId) {
                    duice.ObjectProxy.reset(this.ohlcvSearch);
                    duice.ArrayProxy.clear(this.ohlcvs);
                    this.ohlcvSearch.assetId = assetId;
                    const promise = this.dialog.open();
                    await this.getOhlcvs();
                    return promise;
                },
                getOhlcvs: async function() {
                    let url = new URL(`${_apiUrl}/v1/ohlcvs/${this.ohlcvSearch.assetId}`, document.location.origin);
                    this.ohlcvSearch._status = 'loading';
                    duice.ArrayProxy.clear(this.ohlcvs);
                    await _fetch(url)
                        .then(response => {
                            return response.json();
                        })
                        .then(data => {
                            duice.ArrayProxy.assign(this.ohlcvs, data);
                            this.ohlcvSearch._status = 'completed';
                        });
                }
            }
        </script>
        <div class="display--flex flex-direction--column padding--1em">
            <div>
                <h2>
                    <img class="icon" th:src="@{/static/image/icon-ohlcv.svg}" alt=""/>
                    <span data-th-text="#{fintics.etf.Ohlcv}"></span>
                </h2>
            </div>
            <div class="display--flex flex-direction--column gap--1em padding--1em">
                <div class="overflow-y--scroll box" style="max-height:400px;">
                    <table class="width--100 border--none">
                        <colgroup>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                            <col/>
                        </colgroup>
                        <thead>
                        <tr>
                            <th data-th-text="#{fintics.etf.Ohlcv.date}"></th>
                            <th data-th-text="#{fintics.etf.Ohlcv.open}"></th>
                            <th data-th-text="#{fintics.etf.Ohlcv.high}"></th>
                            <th data-th-text="#{fintics.etf.Ohlcv.low}"></th>
                            <th data-th-text="#{fintics.etf.Ohlcv.close}"></th>
                            <th data-th-text="#{fintics.etf.Ohlcv.volume}"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-duice-bind="ohlcvDialog.ohlcvs" data-duice-loop="ohlcv,status">
                            <td>
                                <span data-duice-bind="ohlcv" data-duice-property="date" class="date"></span>
                            </td>
                            <td>
                                <span data-duice-bind="ohlcv" data-duice-property="open" data-duice-format="number()" class="number"></span>
                            </td>
                            <td>
                                <span data-duice-bind="ohlcv" data-duice-property="high" data-duice-format="number()" class="number"></span>
                            </td>
                            <td>
                                <span data-duice-bind="ohlcv" data-duice-property="low" data-duice-format="number()" class="number"></span>
                            </td>
                            <td>
                                <span data-duice-bind="ohlcv" data-duice-property="close" data-duice-format="number()" class="number"></span>
                            </td>
                            <td>
                                <span data-duice-bind="ohlcv" data-duice-property="volume" data-duice-format="number()" class="number"></span>
                            </td>
                        </tr>
                        <tr data-duice-bind="ohlcvDialog.ohlcvSearch"
                            data-duice-if="return ohlcvDialog.ohlcvSearch._status === 'loading';" hidden>
                            <td colspan="100%" class="text-align--center">
                                <img class="icon font-size--larger" th:src="@{/static/image/loading.svg}" alt="loading"/>
                            </td>
                        </tr>
                        <tr data-duice-bind="ohlcvDialog.ohlcvs"
                            data-duice-if="return ohlcvDialog.ohlcvSearch._status === 'completed' && ohlcvDialog.ohlcvs.length < 1;" hidden>
                            <td colspan="100%" class="text-align--center">
                                <span data-th-text="#{web.global.itemNotFound(#{fintics.etf.Ohlcv})}"></span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </dialog>
    <!-- ================================== -->
    <!-- end: ohlcv dialog                  -->
    <!-- ================================== -->

</th:block>
